name: Auto Generate Release Note

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  update_release_draft:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Generate CalVer version
        id: calver
        run: |
          CURRENT_DATE=$(date "+%Y-%m-%d")
          RELEASE_TAG=$(curl -H 'Accept: application/vnd.github.v3+json' -H 'Authorization: token ${{ secrets.GITHUB_TOKEN }}' https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          TAGS=(${RELEASE_TAG//_/ })
          PREV_RELEASE_DATE=${TAGS[0]}
          VERSION=${TAGS[1]}
          CURRENT_DATE_PREFIX="${VERSION_PREFIX}${CURRENT_DATE}"
          
          if [ "${PREV_RELEASE_DATE}" = "${CURRENT_DATE_PREFIX}" ]; then
            VERSION=$(expr ${VERSION} + 1)
            echo "Already release for the same date, Increment "Version" -> ${VERSION}"
          else
            VERSION=1
          fi

          VERSION="${CURRENT_DATE_PREFIX}_${VERSION}"
          echo version=${VERSION} >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: release-drafter/release-drafter@v5
        with:
          tag: ${{ steps.calver.outputs.version }}
          name: ${{ steps.calver.outputs.version }}
          version: ${{ steps.calver.outputs.version }}
          publish: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_PREFIX: "v"
          TZ: "Asia/Tokyo"
